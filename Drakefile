PROFILE:=default_profile
%include $[PROFILE]

; $ZIP_DEST, $EXTRACT_DEST <- [-timecheck]
wget_unzip()
    mkdir -p $(dirname $OUTPUT0)
    wget --output-document="$OUTPUT0" "$URL"
    unzip -o "$OUTPUT0" -d $OUTPUT1

psql()
    psql -v ON_ERROR_STOP=1 -f $INPUT 2>&1 && echo > $OUTPUT

; create a schema (does not drop)
psql_schema()
    schema=$(basename $OUTPUT)
    psql -v ON_ERROR_STOP=1 -c "CREATE SCHEMA IF NOT EXISTS $schema" && mkdir -p $OUTPUT && echo > $OUTPUT/schema

; take all CSVs from import folder $INPUT and puts into schema with title $OUTPUT
load_data()  
    schema=$(basename "$OUTPUT")
     for filename in "$INPUT"/*
    do
        echo $filename
        file_csv=$(basename "$filename")
        table_name=$(echo $file_csv | sed 's/-/_/g;s/\.[[:alpha:]]*$//') 
        tr -d '(\r|\000)' < "$INPUT"/"$file_csv" | psql -v ON_ERROR_STOP=1 -c '\'"COPY $schema.${table_name,,} FROM STDIN WITH CSV HEADER;"
    done
    echo > $OUTPUT

%include $[BASE]/import/icis/Drakefile
%include $[BASE]/import/tri/Drakefile
%include $[BASE]/import/rcra/Drakefile
%include $[BASE]/import/nysdec_reports/Drakefile
%include $[BASE]/import/Drakefile
%include $[BASE]/import/manifest/Drakefile

; shapefile importing disabled -- steps are broken at the moment
;%include $[BASE]/import/geo/Drakefile

%include $[BASE]/output/Drakefile
